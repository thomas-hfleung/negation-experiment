{{ block content }}
{{if player.round_number <= 1}}
<h1>Practice Round</h1>
{{else}}
    <h1>Round {{player.play_round_number}}</h1>
{{endif}}
<br>
<h2>You are the {{player.type}}.</h2>
<br>
{{if player.type == 'Sender'}}
<div class = "row">
    <div class = column1>
        <h3>Sender</h3>
        <h4>Actions available to the Receiver: <b>A</b>, <b>B</b>, <b>C</b>, <b>D</b>, <b>E</b>, <b>F</b>, <b>G</b></h4>
        <br>
        <h4>Valid actions in this round: <b style="color: green">{{valid_actions}}</b></h4>
        <h4>Invalid actions in this round: <b style="color: red">{{invalid_actions}}</b></h4>
        <hr>
        <h4>Symbols to compose your message:</h4>
        <div id="buttons">
          <!-- Buttons will go here -->
        </div><br>
        <h4>Cost: {{C.COST}} points per symbol</h4>
        <br>
        <h4>Your message choice:</h4>
        <div class = "row">
            <div class = "column2">
                <div id="output"></div>
            </div>
            <div class = "column3">
                <button id="backspace-button" type="button">Delete</button>
            </div>
        </div>
        <div id="cost-display">Total cost: 0 points</div>
        <div id="error-message"></div>

        <form method="post">
            <input type="hidden" name="message" id="message-field">
            <button id="submit-message-button" type="button">Send Message</button>
        </form>
    </div>
    <div class="divider"></div>
    <div class = column1>
    </div>
</div>
{{else}}
<div class = "row">
    <div class = column4>
        <h5>Waiting for Sender's message</h5>
    </div>
    <div class="divider"></div>
    <div class = column1>
        <h3>Receiver</h3>
        <h4>Actions available: <b>A</b>, <b>B</b>, <b>C</b>, <b>D</b>, <b>E</b>, <b>F</b>, <b>G</b></h4>
        <h4>Possible rewards:</h4>
        <center>
        <table class="table">
            <tr>
                <td style="font-weight: bold">Action</td>
                <td style="font-weight: bold">If valid</td>
                <td style="font-weight: bold">If invalid</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="A">A</button></td>
                <td>{{possible_rewards.0}}</td>
                <td>0</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="B">B</button></td>
                <td>{{possible_rewards.1}}</td>
                <td>0</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="C">C</button></td>
                <td>{{possible_rewards.2}}</td>
                <td>0</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="D">D</button></td>
                <td>{{possible_rewards.3}}</td>
                <td>0</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="E">E</button></td>
                <td>{{possible_rewards.4}}</td>
                <td>0</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="F">F</button></td>
                <td>{{possible_rewards.5}}</td>
                <td>0</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="G">G</button></td>
                <td>{{possible_rewards.6}}</td>
                <td>0</td>
            </tr>
        </table>
            </center>
        <hr>
        <h4>Your action choice:</h4>
        <div id="receiver-output"></div>
        <div id="error-message"></div>

        <form method="post">
            <input type="hidden" name="action" id="action-field">
            <button id="submit-action-button" type="button">Submit Choice</button>
        </form>
    </div>

</div>
{{endif}}
<br>
<hr>
<h3>Facts:</h3>
<h4>Probability that the Sender's observed available actions matches the Receiver's available actions: {{player.prob_align_actions}}</h4>
<br>
<h4>Probability of 5 valid actions: {{player.prob_5}}</h4>
<h4>Probability of 2 valid actions: {{prob_2}}</h4>
<br><br>

{{ endblock }}


{% block app_styles %}
<style>
    h1 {
        font-size: 35px;
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
    }
    h2 {
        font-size: 25px;
        font-weight: bold;
    }
    h3 {
        font-size: 25px;
        font-weight: bold;
        text-align: center;
        text-decoration: underline;
    }
    h4 {
        font-size: 20px;
    }
    h5 {
        font-size: 50px;
        text-align: center;
    }
    p {
        font-size: 20px;
    }
    .column1{
        float: left;
        width: 46%;
        padding: 5px;
        height: 600px;
        font-size: 15px;
    }
    .column2{
        float: left;
        width: 60%;
        padding: 10px;
    }
    .column3{
        float: left;
        width: 40%;
        padding: 10px;
    }
    .column4{
        float: left;
        width: 46%;
        padding: 5px;
        height: 600px;

        display: flex;
        justify-content: center;
        align-items: center;
    }
    .row:after {
        content: "";
        display: table;
        clear: both;
    }
    .divider {
    float: left;
    width: 1px;
    border-left: 1px solid black;    /* color of the line */
    height: 600px;              /* match .column1 height */
    margin: 0 10px;             /* optional spacing around the line */
}
    td {
        border: 1px solid black;
        font-size: 20px;
        text-align: center;
    }
    hr {
      border:none;
      border-top:3px dashed black;
      color:#fff;
      background-color:#fff;
      height:1px;
    }
    .letter-button {
      padding: 5px 10px;
      margin: 5px;
      font-size: 18px;
    }
    #output {
      margin-top: 0px;
      font-size: 24px;
      font-weight: bold;
      border: 1px solid #ccc;
      min-height: 40px;
      text-align: center;
    }
    #receiver-output {
      margin-top: 0px;
      font-size: 24px;
      font-weight: bold;
      border: 1px solid #ccc;
      width: 50px;
      min-height: 40px;
      text-align: center;
    }
    #backspace-button {
        margin-top: 5px;
    }
    #error-message {
        font-size: 20px;
        color: red;
        margin-bottom: 10px;
    }
    #cost-display {
        font-size: 20px;
        font-weight: bold;
    }
</style>
{%endblock%}

{% block scripts %}
<script>
  const letters = ['#','%','A','B','C','D','E','F','G'];
  const buttonsDiv = document.getElementById('buttons');
  const outputDiv = document.getElementById('output');
  const backspaceBtn = document.getElementById('backspace-button');
  const errorDiv = document.getElementById('error-message');
  const submitBtn = document.getElementById('submit-message-button');
  const costDiv = document.getElementById('cost-display');
  const costPerSymbol = {{ C.COST }};
  const maxLength = 10;
  let errorTimeout;

  function updateCost() {
    const numSymbols = outputDiv.innerText.length;
    costDiv.innerText = "Total cost: " + (numSymbols * costPerSymbol) + " points";
  }

  // Create buttons dynamically
  if (buttonsDiv) {
      letters.forEach(letter => {
        const btn = document.createElement('button');
        btn.innerText = letter;
        btn.className = 'letter-button';
        btn.type = 'button'; // prevents form submission
        btn.onclick = () => {
          if (outputDiv.innerText.length < maxLength) {
            outputDiv.innerText += letter; // append letter
            clearError();
            updateCost();
          } else {
            showError('Maximum 10 symbols allowed.');
          }
        };
        buttonsDiv.appendChild(btn);
      });
  }
  if (backspaceBtn){
      backspaceBtn.onclick = () => {
        outputDiv.innerText = outputDiv.innerText.slice(0, -1);
        updateCost();
      };
  }


  function showError(message) {
    errorDiv.innerText = message;
    clearTimeout(errorTimeout); // clear previous timeout if any
    errorTimeout = setTimeout(() => {
      errorDiv.innerText = '';
    }, 3000); // hide after 3 seconds
  }

  function clearError() {
    errorDiv.innerText = '';
    clearTimeout(errorTimeout);
  }

  // submit button with error check
  if (submitBtn) {
    submitBtn.onclick = () => {
    const inputField = document.querySelector('input[name="message"]');
    if (!inputField) return;
    if (outputDiv.innerText === '') {
        showError('Please enter at least one symbol.');
        return;
    }
    inputField.value = outputDiv.innerText;  // attach output to form field
    inputField.form.submit();                // submit the form
  };
  }

  // submit button without error check
  submitBtn.onclick = () => {
    const inputField = document.querySelector('input[name="message"]');
    if (!inputField) return;
    inputField.value = outputDiv.innerText;  // attach output to form field
    inputField.form.submit();                // submit the form
    };

  const actionButtons = document.querySelectorAll(".action-button");
  const receiverOutput = document.getElementById("receiver-output");
  const actionsubmitBtn = document.getElementById('submit-action-button');

  if (receiverOutput && actionButtons.length > 0) {
        actionButtons.forEach(button => {
            button.addEventListener("click", function () {
                receiverOutput.innerText = this.innerText; // only one symbol
            });
        });
    }

  if (actionsubmitBtn) {
    actionsubmitBtn.onclick = () => {
    const inputField = document.querySelector('input[name="action"]');
    if (!inputField) return;
    if (receiverOutput.innerText === '') {
        showError('Please select an action.');
        return;
    }
    inputField.value = receiverOutput.innerText;  // attach output to form field
    inputField.form.submit();                // submit the form
  };
  }
</script>

{{endblock}}

<table class="table">
            <colgroup>
                <col style="width: 35%;">   <!-- Action column -->
                <col style="width: 35%;">   <!-- If valid column -->
                <col style="width: 30%;">   <!-- If invalid column -->
            </colgroup>
            <tr>
                <td style="font-weight: bold">Action</td>
                <td style="font-weight: bold">If valid</td>
                <td style="font-weight: bold">If invalid</td>
            </tr>
            <tr>
                <td {% if group.action == "A" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="A" id="action-button" {% if group.action == "A" %}style="background-color: lightskyblue;"{% endif %}>A</button></td>
                <td {% if "A" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.0}}</td>
                <td {% if "A" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td {% if group.action == "B" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="B" id="action-button" {% if group.action == "B" %}style="background-color: lightskyblue;"{% endif %}>B</button></td>
                <td {% if "B" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.1}}</td>
                <td {% if "B" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td {% if group.action == "C" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="C" id="action-button" {% if group.action == "C" %}style="background-color: lightskyblue;"{% endif %}>C</button></td>
                <td {% if "C" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.2}}</td>
                <td {% if "C" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td {% if group.action == "D" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="D" id="action-button" {% if group.action == "D" %}style="background-color: lightskyblue;"{% endif %}>D</button></td>
                <td {% if "D" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.3}}</td>
                <td {% if "D" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td {% if group.action == "E" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="E" id="action-button" {% if group.action == "E" %}style="background-color: lightskyblue;"{% endif %}>E</button></td>
                <td {% if "E" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.4}}</td>
                <td {% if "E" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td {% if group.action == "F" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="F" id="action-button" {% if group.action == "F" %}style="background-color: lightskyblue;"{% endif %}>F</button></td>
                <td {% if "F" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.5}}</td>
                <td {% if "F" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td {% if group.action == "G" %}style="background-color: lightskyblue;"{% endif %}><button type="button" class="action-button" data-letter="G" id="action-button" {% if group.action == "G" %}style="background-color: lightskyblue;"{% endif %}>G</button></td>
                <td {% if "G" in valid_actions %}style="background-color: lightgreen;"{% endif %}>{{possible_rewards.6}}</td>
                <td {% if "G" not in valid_actions %}style="background-color: red;"{% endif %}>{{C.INVALID_REWARD}}</td>
            </tr>
        </table>


{{if group.message == ""}}<b style="color: saddlebrown">No message</b> {{else}} <b style="color: saddlebrown">{{group.message}}</b>{{endif}}</h4>

