{{ block content }}
{{if player.round_number <= C.PRACTICE_ROUNDS}}
<h1>Practice Round {{player.round_number}} (Against yourself)</h1>
{{else}}
    <h1>Round {{player.play_round_number}}</h1>
{{endif}}
<br>
<div class = "row">
    <div class = column1>
        <h2>You are the Sender.</h2>
        <br>
        <h4>
            Observed Actions:
            {% for action in sender_actions %}
                {% if action in valid_actions %}
                    <span style="font-weight: bold; text-decoration: underline">{{ action }}</span>
                {% elif action in invalid_actions %}
                    <span style="font-weight: bold;">{{ action }}</span>
                {% else %}
                    {{action}}
                {% endif %}
            {% endfor %}
        </h4>
        <!--
        <h4>Observed Available Actions: <b>{{sender_actions}}</b></h4>
        <br>
        <h4>Valid actions in this round: <b style="color: blue">{{valid_actions}}</b></h4>
        <h4>Observed invalid actions in this round: <b style="color: red">{{invalid_actions}}</b></h4>
        -->
        <br>
        <h4><b>Reminder</b>:</h4>
        <h4>Actions <span style="text-decoration: underline">underlined</span> are the <span style="font-weight: bold">valid</span> actions.</h4>
        <h4>Only the <span style="font-weight: bold">valid</span> actions are always available to the Receiver.</h4>
        {{if player.round_number <= C.PRACTICE_ROUNDS}}
        <br>
            {{if group.valid_no == 5}}
            <h4><b>Note:</b> There are {{group.valid_no}} valid actions in this round, which happens with {{prob_5}}% chance.</h4>
            {{else}}
            <h4><b>Note:</b> There are {{group.valid_no}} valid actions in this round, which happens with {{prob_2}}% chance.</h4>
            {{endif}}
        {{endif}}
        <hr>
        <h4>Symbols to compose your message:</h4>
        <div id="symbol_buttons">
          <!-- Buttons will go here -->
        </div>
        <div id="letter_buttons">
          <!-- Buttons will go here -->
        </div><br>
        <h4>Cost: {{C.COST}} points per symbol (First one is free)</h4>
        <br>
        <h4>Your message choice:</h4>
        <div class = "row">
            <div class = "column2">
                <div id="output"></div>
            </div>
            <div class = "column3">
                <button id="backspace-button" type="button" style="border-color: white; font-size: 20px;">Delete</button>
            </div>
        </div>
        <div id="error-message"></div>
        <div id="cost-display">Total cost: <span style="color: red">0 points</span></div>
        <br>

        <form method="post">
            <input type="hidden" name="message" id="message-field">
            <button id="submit-message-button" type="button">Send Message</button>
        </form>
    </div>
    <div class="divider"></div>
    <div class = column1 style = "display: flex; flex-direction: column; justify-content: center">
        <h3>Reminder:</h3>
        <h5>Probability that the seven observed actions matches with the Receiver's: {{prob_align}}%</h5>
        <br>
        <h5>Probability of 5 valid actions: {{prob_5}}%</h5>
        <h5>Probability of 2 valid actions: {{prob_2}}%</h5>
    </div>
</div>

{{ endblock }}


{% block app_styles %}
<style>
    h1 {
        font-size: 35px;
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
    }
    h2 {
        font-size: 25px;
        font-weight: bold;
    }
    h3 {
        font-size: 25px;
        font-weight: bold;
        text-align: center;
        text-decoration: underline;
    }
    h4 {
        font-size: 22px;
    }
    h5 {
        font-size: 25px;
        text-align: center;
    }
    .column1{
        float: left;
        width: 48%;
        padding: 5px;
        height: auto;
        font-size: 15px;
    }
    .column2{
        float: left;
        width: 60%;
        padding: 10px;
    }
    .column3{
        float: left;
        width: 40%;
        padding: 10px;
    }
    .row {
        display: flex;
        justify-content: center;
        align-items: stretch; /* ensures all children match tallest height */
        flex-wrap: wrap;      /* allows stacking on small screens */
    }
    .divider {
        float: left;
        width: 1px;
        border-left: 1px solid black;    /* color of the line */
        align-self: stretch;              /* match .column1 height */
        margin: 0 5px;             /* optional spacing around the line */
    }
    td {
        border: 1px solid black;
        font-size: 20px;
        text-align: center;
    }
    hr {
      border:none;
      border-top:3px dashed black;
      color:#fff;
      background-color:#fff;
      height:1px;
    }
    .letter-button {
        width: 45px;
        height: 45px;
        margin: 10px;
        font-size: 23px;
        font-weight: bold;
        border-color: black;
    }
    #output {
      margin-top: 0px;
      font-size: 24px;
      font-weight: bold;
      border: 1px solid #ccc;
      min-height: 40px;
      text-align: center;
    }
    #backspace-button {
        margin-top: 5px;
    }
    #error-message {
        font-size: 20px;
        color: red;
        margin-bottom: 10px;
    }
    #cost-display {
        font-size: 20px;
        font-weight: bold;
    }
    #submit-message-button {
        border-color: white;
        font-size: 25px;
        background-color: yellowgreen;
    }
    .otree-body, .container, .content {
  width: 100% !important;
  max-width: 70% !important;
  margin: 0 auto !important;
  padding: 0 10px; /* optional small horizontal padding */
}
</style>
{%endblock%}

{% block scripts %}
<script>
  symbols = ['*','#','%'];
  letters = ['a','b','c','d','e','f','g','h','i','j','k','l'];
  const symbolsDiv = document.getElementById('symbol_buttons');
  const lettersDiv = document.getElementById('letter_buttons');
  const outputDiv = document.getElementById('output');
  const backspaceBtn = document.getElementById('backspace-button');
  const errorDiv = document.getElementById('error-message');
  const submitBtn = document.getElementById('submit-message-button');
  const costDiv = document.getElementById('cost-display');
  const costPerSymbol = {{ C.COST }};
  const maxLength = 10;
  let errorTimeout;

  function updateCost() {
    const numSymbols = outputDiv.innerText.length;
    // First symbol free: only charge for symbols beyond the first
    const chargeableSymbols = Math.max(0, numSymbols - 1);
    const totalCost = chargeableSymbols * costPerSymbol;

    // Using innerHTML to preserve the red color styling
    costDiv.innerHTML = `Total cost: <span style="color: red">${totalCost} points</span>`;
}

  // Create buttons dynamically
  symbols.forEach(symbol => {
    const btn = document.createElement('button');
    btn.innerText = symbol;
    btn.className = 'letter-button';
    btn.type = 'button'; // prevents form submission
    btn.onclick = () => {
      if (outputDiv.innerText.length < maxLength) {
        outputDiv.innerText += symbol; // append letter
        clearError();
        updateCost();
      } else {
        showError('Maximum 10 symbols allowed.');
      }
    };
    symbolsDiv.appendChild(btn);
  });

  letters.forEach(letter => {
    const btn = document.createElement('button');
    btn.innerText = letter;
    btn.className = 'letter-button';
    btn.type = 'button'; // prevents form submission
    btn.onclick = () => {
      if (outputDiv.innerText.length < maxLength) {
        outputDiv.innerText += letter; // append letter
        clearError();
        updateCost();
      } else {
        showError('Maximum 10 symbols allowed.');
      }
    };
    lettersDiv.appendChild(btn);
  });

  backspaceBtn.onclick = () => {
    outputDiv.innerText = outputDiv.innerText.slice(0, -1);
    updateCost();
  };



  function showError(message) {
    errorDiv.innerText = message;
    clearTimeout(errorTimeout); // clear previous timeout if any
    errorTimeout = setTimeout(() => {
      errorDiv.innerText = '';
    }, 3000); // hide after 3 seconds
  }

  function clearError() {
    errorDiv.innerText = '';
    clearTimeout(errorTimeout);
  }


    if (submitBtn) {
    submitBtn.onclick = () => {
    const inputField = document.querySelector('input[name="message"]');
    if (!inputField) return;
    if (outputDiv.innerText === '') {
        showError('Please enter at least one symbol.');
        return;
    }
    inputField.value = outputDiv.innerText;  // attach output to form field
    inputField.form.submit();                // submit the form
  };}

</script>

{{endblock}}