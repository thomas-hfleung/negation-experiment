{{ block content }}
<head>
  <title>Instructions</title>
</head>
<body>
  {{ if form.errors }}
        <div class="alert alert-danger" role="alert">
            <h6 class="alert-heading">Some of the answers are incorrect, please read the instructions carefully again.</h6>
        </div>
    {{ endif }}
  <h1><u>Instructions</u></h1>
  <br>
  <p>
    Welcome to the experiment. This experiment studies decision making in pairs of individuals.
    It will last approximately 90 minutes. There will be
    <b>{{num_playrounds}}</b> rounds, and in each round you will be making one decision.
    Please read these instructions carefully. The cash payment you will receive at the end of the experiment will depend on the decisions you make.
      You will not learn the identity of any participants, nor will any participants learn your identity, even after the end of the experiment.
  </p>

  <h3>Your Role and Your Partner</h3>
  <p>
    There are <b>{{num_players}}</b> participants in today's session. Following the practice rounds, half of the participants will be randomly assigned
    to the role of a <b>Sender</b>. The other half will be randomly assigned to the role of a <b>Receiver</b>.
    Your <b>role stays the same</b> throughout the experiment. Each Sender will be paired with a Receiver so that
      <b>{{num_groups}}</b> pairs are formed. You <b>remain in the same pair</b> for the duration of the experiment.
  </p>

  <h3>Actions and Rewards</h3>
  <p>
    There are twelve possible actions <b>A</b>, <b>B</b>, <b>C</b>, <b>D</b>,
    <b>E</b>, <b>F</b>, <b>G</b>, <b>H</b>, <b>I</b>, <b>J</b>, <b>K</b>, and <b>L</b> and seven positive rewards, <b>100, 90, 80, 70, 60, 50, and 40 points</b>.
  </p>
  <p>
      In each round, the computer randomly selects seven actions from the twelve possible actions. Only these seven actions will be available for the Receiver to take in that round.
      Then, it randomly assigns each of the seven positive rewards with equal chance to one of the seven actions available to the Receiver.
  </p>
  <p>
      The computer also randomly determines which of the actions available to the Receiver are <b>valid</b>.
      There are either <b>two valid actions and five other actions</b> or <b>five valid actions and two other actions</b>, with a {{prob_2}}% and {{prob_5}}% chance respectively.
      For any fixed number of valid actions, all selections of valid actions are equally likely.
  </p>
  <p>
      In each round the computer also selects seven actions from the twelve possible actions, which are shown to the Sender.
  </p>
  <p>
      With <b>{{prob_align}}%</b> chance, the seven actions which the Sender sees are the same as the seven actions available to the Receiver.
      For the Sender, the two or five valid actions are <span style="text-decoration: underline">underlined</span>.
  </p>
  <p>
      With <b>{{prob_not_align}}%</b> chance, two of the seven actions which the Sender sees differ from the seven actions available to the Receiver.
      The Sender <i>always</i> sees the two or five valid actions, which are <span style="text-decoration: underline">underlined</span>.
      The two actions that differ are drawn with equal chance from all possible actions other than those available to the Receiver.
  </p>
  <p>
      <b>Example:</b> Suppose the computer selects the seven actions A, B, C, D, E, F, G as the actions available to the Receiver and the five actions A, B, E, F, G as being valid.
      Then with 80% chance the Sender sees <u>A</u>, <u>B</u>, C, D, <u>E</u>, <u>F</u>, <u>G</u>, that is, the Sender sees the same actions as the Receiver, with the valid actions <span style="text-decoration: underline">underlined</span>.
      With 20% chance the Sender sees <u>A</u>, <u>B</u>, X, Y, <u>E</u>, <u>F</u>, <u>G</u>, where the actions X and Y are drawn from H, I, J, K, L. Again, the valid actions are <span style="text-decoration: underline">underlined</span>.
  </p>
  <p>
      Both participants in the same pair obtain the <b>same reward</b>. The reward is determined jointly by the <b>action</b>
    taken and the <b>validity</b> of that action. For your pair to receive a positive reward, the Receiver must take a <b>valid action</b>.
      The reward from any <b>other action</b> is <b>{{C.INVALID_REWARD}} points</b>.

  </p>
  <!--
  <p>
      In each round, the computer randomly selects <b>7</b> actions as the <b><i>Receiver Available Actions</i></b>. Then, the computer randomly assigns rewards to the available actions. Each of the seven rewards is assigned to one of
    the seven actions. At the same time, the computer randomly determines which actions are <b>valid</b>. There are either <b>five valid actions</b>
      or <b>two valid actions</b> with the probability of having five valid actions as <b>{{player.prob_5}}</b>. The reward from an action that is not valid is 0 points instead of the assigned reward.
  </p>
  <p>
      The sender will observe <b>7</b> actions available to the Receiver, called the <b><i>"Observed Available Actions"</i></b>. It might or might not be the same as the <i>Receiver Available Actions</i>,
      but it will <span class="red">always include the valid actions</span>. With probability <b>{{player.prob_align_actions}}</b>, the <i>Observed Available Actions</i> will be the same as the <i>Receiver Available Actions</i>;
      With probability <b>{{prob_not_align}}</b>, the invalid actions are randomly drawn from the remaining actions. For example, if there are five valid actions in this round (e.g. A, B, C, D, E), the invalid actions will be
      randomly selected from the remaining 7 actions (F, G, H, J, K, L, M).
  </p>
  <p>
    Both participants in the same pair obtain the same reward. The reward is determined jointly by the <b>Action</b>
    taken and the <b>Validity</b> of that action. For your pair to receive a positive reward, the receiver must take an action that is <b>valid</b>.
      Both players are endowed with {{C.ENDOWMENT}} points in each round.
  </p>
  -->


  <h3>The Sender’s Decision</h3>
  <p>
      If you are a Sender, you, but not the Receiver, will learn <b>which actions are valid</b>. You will not learn the assignment of rewards to actions.
      After learning which actions are valid, you choose a <b>message</b> to send to the Receiver.
  </p>
  <p>
      Each message is a string of up to 10 symbols. You can freely assemble your message using the symbols:
    <b>*</b>, <b>%</b>, <b>#</b>, <b>a</b>, <b>b</b>, <b>c</b>, <b>d</b>, <b>e</b>, <b>f</b>, <b>g</b>, <b>h</b>, <b>i</b>, <b>j</b>, <b>k</b>, and <b>l</b> by clicking the corresponding buttons.
    You can change your message by using the “Delete” button. Once you have finished assembling your message, click the “Send Message” button. <!--You are allowed to send an empty message. The receiver will see "No message" when that is the case. -->
  </p>
  <p>
      The first symbol in your message is costless. Each additional symbol <b>costs</b> both you and the Receiver <b>{{C.COST}}</b> points. An example of the screen a Sender will see is as follows.
  </p>
  <br>
  <div class = "row">
    <div class = column1>
        <h5>Sender</h5>
        <br>
        <h4>Observed Available Actions: <b>A</b> , <b>C</b> , <b style="text-decoration: underline">D</b> , <b>E</b> , <b>F</b> , <b>G</b> , <b style="text-decoration: underline">L</b></h4>
        <br>
        <h4><b>Reminder</b>:</h4>
        <h4>Actions <span style="text-decoration: underline">underlined</span> are the <span style="font-weight: bold">valid</span> actions.</h4>
        <h4>Only the <span style="font-weight: bold">valid</span> actions are always available to the Receiver.</h4>
        <hr>
        <h4>Symbols to compose your message:</h4>
        <div id="symbol_buttons">
          <!-- Buttons will go here -->
        </div>
        <div id="letter_buttons">
          <!-- Buttons will go here -->
        </div><br>
        <h4>Cost: {{C.COST}} points per symbol (First one is free)</h4>
        <br>
        <h4>Your message choice:</h4>
        <div class = "row">
            <div class = "column2">
                <div id="output"></div>
            </div>
            <div class = "column3">
                <button id="backspace-button" type="button" style="border-color: white; font-size: 20px;">Delete</button>
            </div>
        </div>
        <div id="error-message-sender"></div>
        <div id="cost-display">Total cost: <span style="color: red">0 points</span></div>
        <br>

        <form method="post">
            <input type="hidden" name="message" id="message-field">
            <button id="submit-message-button" type="button">Send Message</button>
        </form>
    </div>
</div>
  <br>

  <h3>The Receiver’s Decision</h3>
  <p>
      If you are a Receiver, you will take <b>one</b> of the seven Receiver actions available to you. Each of those actions is assigned a different positive reward from among <b>100, 90, 80, 70, 60, 50, and 40 points</b>.
      You, but not the Sender, will see the <b>assignment of positive rewards to actions</b>. In addition, you see the message from the Sender, who knows which actions are valid.
  </p>
  <p>
      If you choose a <b>valid action</b>, both you and the Sender will receive the positive reward assigned to that action. If you choose any <b>other action</b>,
      your reward and the Sender’s reward is <b>{{C.INVALID_REWARD}} points</b>. You choose an action by clicking the corresponding button.
      An example of the screen that a Receiver will see is as follows.
  </p>
  <br>
  <div class = "row">
    <div class = column4>
        <h5>Receiver</h5>
        <br>
        <h4>Actions available: <b>B</b> , <b>C</b> , <b>D</b> , <b>E</b> , <b>F</b> , <b>K</b> , <b>L</b></h4>
        <h4>Sender's message: <span class="placeholder-box">"The Sender's message"</span></h4>
        <hr>
        <h4>Possible rewards:</h4>
        <center>
        <table class="table">
            <colgroup>
                <col style="width: 35%;">   <!-- Action column -->
                <col style="width: 35%;">   <!-- If valid column -->
                <col style="width: 30%;">   <!-- If invalid column -->
            </colgroup>
            <tr>
                <td style="font-weight: bold">Action</td>
                <td style="font-weight: bold">If valid</td>
                <td style="font-weight: bold">Otherwise</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="B" id="action-button">B</button></td>
                <td>{{possible_rewards.0}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="C" id="action-button">C</button></td>
                <td>{{possible_rewards.1}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="D" id="action-button">D</button></td>
                <td>{{possible_rewards.2}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="E" id="action-button">E</button></td>
                <td>{{possible_rewards.3}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="F" id="action-button">F</button></td>
                <td>{{possible_rewards.4}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="K" id="action-button">K</button></td>
                <td>{{possible_rewards.5}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
            <tr>
                <td><button type="button" class="action-button" data-letter="L" id="action-button">L</button></td>
                <td>{{possible_rewards.6}}</td>
                <td>{{C.INVALID_REWARD}}</td>
            </tr>
        </table>
            </center>
        <h4>Your action choice: <div id="receiver-output"></div></h4>
        <div id="error-message-receiver"></div>

        <form method="post">
            <input type="hidden" name="action" id="action-field">
            <button id="submit-action-button" type="button">Submit Choice</button>
        </form>
    </div>

</div>
  <br>

  <h3>Information Feedback – for both Sender and Receiver</h3>
  <p>
      At the end of each round, you will be provided with a summary of what happened in that round, including which actions the Sender saw, which actions were valid,
      the Sender’s choice of message, the message cost incurred, the actions available to the Receiver, the assignment of positive rewards to actions,
      the Receiver’s choice of action, and your reward for that round.
  </p>

  <h3>Your Cash Payment</h3>
  <p>
      In each round both players are <b>endowed with {{C.ENDOWMENT}} points</b>.
      The <b>payoff in points</b> you obtain in each round will be the [<b>{{C.ENDOWMENT}} points endowment</b> <b>−</b> the <b>message cost</b> <b>+</b> the <b>reward</b> for that round].
      The computer will randomly select <b>2 rounds</b> out of the {{num_playrounds}} to calculate your cash payment.
      The higher payoff among the 2 rounds will be selected as your payoff of the experiment.
      The points you earned will be converted to US dollars at a <b>6:1 exchange rate</b>, rounded up (thus, for example, 100 points correspond to $16.66).
      Your total cash payment will be the amount you earned in the selected round plus a $7 show-up fee.
  </p>

  <h3>Timeline</h3>
  <center>
  <img src="{% static 'T3.jpg' %}"
     style="width: 60%; height: auto;"
     alt="Figure">
  </center>
  Figure 1 shows the timeline of one round. It summarizes what happens in one round according to the instructions above.

  <h3>Quiz and Practice</h3>
  <p>
      To ensure your comprehension of the instructions, we will give you a quiz and {{C.PRACTICE_ROUNDS}} practice rounds.
      We will go through the quiz after you answer it on your own. In the practice rounds, you will act as both Sender and Receiver and <b>play against yourself</b>.
      Once the practice round is over, the computer will tell you “The official rounds begin now!” and you will be randomly assigned to either the role of Sender or the role of Receiver.
  </p>

  <h3>Administration</h3>
  <p>
      Your decisions as well as your monetary payment will be kept confidential. Remember that you have to make your decisions entirely on your own.
      Please do not discuss your decisions with any other participants.
  </p>
  <p>
    Upon finishing the experiment, you will receive your cash payment. You will be asked to sign your name to acknowledge your receipt of the payment. You are then free to leave.
  </p>
  <p>
      If you have any question, please raise your hand. We will answer your question individually. If there is no question, we will proceed to the quiz now.
  </p>

  <h3>Quiz</h3>
  <div class="quiz-question">
    1. I will remain as a Sender or a Receiver in all {{num_playrounds}} rounds.<br>
    {{formfield "q1"}}
  </div>
  <div class="quiz-question">
    2. I will be paired with the same participant in all {{num_playrounds}} rounds.<br>
    {{formfield "q2"}}
  </div>
  <div class="quiz-question">
    3. At the start of each round, the Sender, but not the Receiver, will learn which actions are valid.<br>
    {{formfield "q3"}}
  </div>
  <div class="quiz-question">
    4. The Sender will be responsible for choosing an action for the pair, while the Receiver will be sending messages.<br>
    {{formfield "q4"}}
  </div>
  <div class="quiz-question">
      5. If the valid actions are <b>A</b> and <b>B</b>, the sender can observe the actions B, C, F, G, J, K, L. <br>
    {{formfield "q5"}}
  </div>
  <div class="quiz-question">
    6. Only the Sender will pay the cost of the message.<br>
    {{formfield "q6"}}
  </div>

  <center><button type="submit">Submit</button></center>
</body>
{{ endblock }}

{% block app_styles %}

<style>
    body {
      line-height: 1.5;
      font-size: 20px;
      margin: 20px;
    }
    h1 {
      text-align: center;
      margin-top: 2em;
      font-size: 40px;
      font-weight: bold;
    }
    h2, h3 {
      text-align: center;
      margin-top: 2em;
      font-size: 35px;
    }
    h5 {
        font-size: 25px;
        font-weight: bold;
        text-align: center;
        text-decoration: underline;
    }
    h4 {
        font-size: 22px;
    }
    hr {
      border:none;
      border-top:3px dashed black;
      color:#fff;
      background-color:#fff;
      height:1px;
    }
    .row {
        display: flex;
        justify-content: center;
        align-items: stretch; /* ensures all children match tallest height */
        flex-wrap: wrap;      /* allows stacking on small screens */
    }
    .column1{
        width: 50%;
        padding: 5px;
        height: auto;
        font-size: 15px;
    }
    .column2{
        float: left;
        width: 60%;
        padding: 10px;
    }
    .column3{
        float: left;
        width: 40%;
        padding: 10px;
    }
    .column4{
        width: 48%;
        padding: 5px;
        height: auto;
        font-size: 15px;
    }
    .red {
      color: red;
      font-weight: bold;
    }
    .quiz-question {
      margin-top: 1em;
    }
    .otree-form-errors {
            display: none;
        }
    h6 {
      text-align: center;
      font-size: 25px;
    }
    .letter-button {
        width: 45px;
        height: 45px;
        margin: 10px;
        font-size: 23px;
        font-weight: bold;
        border-color: black;
    }
    #output {
      margin-top: 0px;
      font-size: 24px;
      font-weight: bold;
      border: 1px solid #ccc;
      min-height: 40px;
      text-align: center;
    }
    #error-message-sender {
        font-size: 20px;
        color: red;
        margin-bottom: 10px;
    }
    #error-message-receiver {
        font-size: 20px;
        color: red;
        margin-bottom: 10px;
    }
    #backspace-button {
        margin-top: 5px;
    }
    #cost-display {
        font-size: 20px;
        font-weight: bold;
    }
    #submit-message-button {
        border-color: white;
        font-size: 25px;
        background-color: yellowgreen;
    }
    p {
      text-align: justify;
        font-size: 22px;
    }
    .highlight {
    background-color: orange;
    }
    td {
        border: 1px solid black;
        font-size: 20px;
        text-align: center;
        vertical-align: middle;
    }
    #receiver-output {
        display: inline-block;    /* This allows it to stay on the same line */
        vertical-align: middle;   /* This aligns the box vertically with the text */
        margin-left: 10px;        /* Adds a little space between the text and the box */
        margin-top: 0px;
        font-size: 24px;
        font-weight: bold;
        border: 1px solid #ccc;
        width: 50px;
        min-height: 40px;
        text-align: center;
        line-height: 40px;        /* Centers the letter vertically inside the box */
    }
    #submit-action-button {
        border-color: white;
        font-size: 25px;
        background-color: yellowgreen;
    }
    #action-button {
        width: 40px;
        height: 40px;
        font-size: 20px;
        font-weight: bold;
    }
    .otree-body, .container, .content {
      width: 100% !important;
      max-width: 70% !important;
      margin: 0 auto !important;
      padding: 0 10px; /* optional small horizontal padding */
    }
    .placeholder-box {
        display: inline-block;
        vertical-align: middle;
        width: 250px;          /* Width to fit a few symbols */
        height: 40px;          /* Matches your #output height */
        border: 1px solid #ccc;
        background-color: #f9f9f9; /* Light grey to show it's a box */
        margin-left: 10px;
        color: saddlebrown;
  </style>
{% endblock %}

{% block scripts %}
<script>
  symbols = ['*','#','%'];
  letters = ['a','b','c','d','e','f','g','h','i','j','k','l'];
  const symbolsDiv = document.getElementById('symbol_buttons');
  const lettersDiv = document.getElementById('letter_buttons');
  const outputDiv = document.getElementById('output');
  const backspaceBtn = document.getElementById('backspace-button');
  const errorDivSender = document.getElementById('error-message-sender');
  const errorDivReceiver = document.getElementById('error-message-receiver');
  const submitBtn = document.getElementById('submit-message-button');
  const costDiv = document.getElementById('cost-display');
  const costPerSymbol = {{ C.COST }};
  const maxLength = 10;
  let errorTimeoutSender;
  let errorTimeoutReceiver;

  function updateCost() {
    const numSymbols = outputDiv.innerText.length;
    // First symbol free: only charge for symbols beyond the first
    const chargeableSymbols = Math.max(0, numSymbols - 1);
    const totalCost = chargeableSymbols * costPerSymbol;

    // Using innerHTML to preserve the red color styling
    costDiv.innerHTML = `Total cost: <span style="color: red">${totalCost} points</span>`;
}

  // Create buttons dynamically
  symbols.forEach(symbol => {
    const btn = document.createElement('button');
    btn.innerText = symbol;
    btn.className = 'letter-button';
    btn.type = 'button'; // prevents form submission
    btn.onclick = () => {
      if (outputDiv.innerText.length < maxLength) {
        outputDiv.innerText += symbol; // append letter
        clearErrorSender();
        updateCost();
      } else {
        showErrorSender('Maximum 10 symbols allowed.');
      }
    };
    symbolsDiv.appendChild(btn);
  });

  letters.forEach(letter => {
    const btn = document.createElement('button');
    btn.innerText = letter;
    btn.className = 'letter-button';
    btn.type = 'button'; // prevents form submission
    btn.onclick = () => {
      if (outputDiv.innerText.length < maxLength) {
        outputDiv.innerText += letter; // append letter
        clearErrorSender();
        updateCost();
      } else {
        showErrorSender('Maximum 10 symbols allowed.');
      }
    };
    lettersDiv.appendChild(btn);
  });

  backspaceBtn.onclick = () => {
    outputDiv.innerText = outputDiv.innerText.slice(0, -1);
    updateCost();
  };



  function showErrorSender(message) {
    errorDivSender.innerText = message;
    clearTimeout(errorTimeoutSender); // clear previous timeout if any
    errorTimeoutSender = setTimeout(() => {
      errorDivSender.innerText = '';
    }, 3000); // hide after 3 seconds
  }

  function clearErrorSender() {
    errorDivSender.innerText = '';
    clearTimeout(errorTimeoutSender);
  }

  function showErrorReceiver(message) {
    errorDivReceiver.innerText = message;
    clearTimeout(errorTimeoutReceiver); // clear previous timeout if any
    errorTimeoutReceiver = setTimeout(() => {
      errorDivReceiver.innerText = '';
    }, 3000); // hide after 3 seconds
  }

  function clearErrorReceiver() {
    errorDivReceiver.innerText = '';
    clearTimeout(errorTimeoutReceiver);
  }


    if (submitBtn) {
    submitBtn.onclick = () => {
    const inputField = document.querySelector('input[name="message"]');
    if (!inputField) return;
    if (outputDiv.innerText === '') {
        showErrorSender('Please enter at least one symbol.');
        return;
    }
  };
  }

  const actionButtons = document.querySelectorAll(".action-button");
  const receiverOutput = document.getElementById("receiver-output");
  const actionsubmitBtn = document.getElementById('submit-action-button');

  if (receiverOutput && actionButtons.length > 0) {
        actionButtons.forEach(button => {
            button.addEventListener("click", function () {
                receiverOutput.innerText = this.innerText; // only one symbol
                actionButtons.forEach(btn => {
                btn.closest("tr").classList.remove("highlight");
                btn.classList.remove("highlight");
            });

            // Highlight this row and button
            this.closest("tr").classList.add("highlight");
            this.classList.add("highlight");
            });
        });
    }


    actionsubmitBtn.onclick = () => {
    const inputField = document.querySelector('input[name="action"]');
    if (!inputField) return;
    if (receiverOutput.innerText === '') {
        showErrorReceiver('Please select an action.');
        return;
    }
  };

</script>

{{endblock}}